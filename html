<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Master v5 - Spaced Repetition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --success: #059669; --error: #dc2626; --text: #1e293b; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 20px; color: var(--text); }
        .card { background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 500px; text-align: center; }
        button { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; margin-top: 10px; font-size: 1rem; font-weight: 600; width: 100%; }
        .btn-secondary { background: #64748b; margin-top: 5px; }
        input[type="text"], input[type="number"] { width: 100%; box-sizing: border-box; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; margin: 10px 0; font-size: 1.1rem; text-align: center; }
        .hidden { display: none; }
        .review-word { font-size: 1.8rem; font-weight: 800; color: var(--primary); display: block; text-align: center; }
        .review-phonetic { font-size: 1.1rem; color: var(--error); text-align: center; display: block; margin-bottom: 15px; }
        .mode-box { background: #eff6ff; padding: 15px; border-radius: 10px; margin: 15px 0; border: 1px solid #dbeafe; font-size: 0.9rem; text-align: left; }
        .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; margin-bottom: 5px; }
        .badge-new { background: #dcfce7; color: #166534; }
        .badge-review { background: #fef9c3; color: #854d0e; }
    </style>
</head>
<body>

    <div id="setup-screen" class="card">
        <h2>ðŸš€ IELTS Smart Review</h2>
        <p>Upload your Master Excel file</p>
        <input type="file" id="upload" accept=".xlsx, .xls" />
        
        <div id="config" class="hidden">
            <div class="mode-box">
                <strong>Learning Strategy:</strong><br>
                <span>âœ¨ 70% New Words + 30% Random Review</span>
                <div id="stats" style="margin-top:10px; font-size:0.8rem; color:#64748b;"></div>
            </div>
            <p>Number of words to study:</p>
            <input type="number" id="total-to-learn" value="10" min="1">
            <button onclick="startSession()">START SESSION</button>
            <button class="btn-secondary" onclick="resetHistory()" style="font-size: 0.7rem;">Clear All History</button>
        </div>
    </div>

    <div id="study-screen" class="card hidden">
        <div id="word-status-badge"></div>
        <div id="question-phase">
            <div id="exercise-type" style="font-size:0.7rem; font-weight:bold; color:#94a3b8; text-transform:uppercase;"></div>
            <div id="display-meaning-q" style="font-size:1.5rem; font-weight:700; margin:15px 0;"></div>
            <button class="btn-secondary" onclick="playAudio()">ðŸ”Š LISTEN</button>
            <input type="text" id="user-input" placeholder="Type answer..." autocomplete="off">
            <button onclick="checkAnswer()">CHECK</button>
        </div>

        <div id="review-area" class="hidden" style="text-align:left; border-top:2px solid #f1f5f9; margin-top:20px; padding-top:20px;">
            <div id="feedback" style="text-align:center; font-weight:bold; font-size:1.2rem; margin-bottom:10px;"></div>
            <span class="review-word" id="rev-word"></span>
            <span class="review-phonetic" id="rev-phonetic"></span>
            <p><strong>Definition:</strong> <span id="rev-meaning"></span></p>
            <p><strong>Example:</strong> <span id="rev-example"></span></p>
            <p><strong>Synonyms:</strong> <span id="rev-synonyms"></span></p>
            <button id="btn-continue" onclick="continueNext()" style="background:var(--success);">CONTINUE (Enter)</button>
        </div>
    </div>

    <script>
        let masterWords = [];
        let sessionQueue = [];
        let isReviewMode = false;
        const HISTORY_KEY = 'ielts_mastery_v5';

        document.getElementById('upload').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                masterWords = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                showStats();
                document.getElementById('config').classList.remove('hidden');
            };
            reader.readAsArrayBuffer(e.target.files[0]);
        });

        function showStats() {
            let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || "{}");
            let masteredCount = Object.keys(history).length;
            document.getElementById('stats').innerText = `Total words in file: ${masterWords.length} | Words you've learned: ${masteredCount}`;
        }

        function startSession() {
            let limit = parseInt(document.getElementById('total-to-learn').value);
            let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || "{}");
            
            // 1. Separate New vs Old
            let newWordsPool = masterWords.filter(w => !history[w.word.toLowerCase()]);
            let reviewPool = masterWords.filter(w => history[w.word.toLowerCase()]);

            // 2. Calculate Mix (70/30)
            let newCount = Math.ceil(limit * 0.7);
            let reviewCount = limit - newCount;

            let selectedNew = newWordsPool.sort(() => 0.5 - Math.random()).slice(0, newCount);
            let selectedReview = reviewPool.sort(() => 0.5 - Math.random()).slice(0, reviewCount);

            // 3. Final Pool
            sessionQueue = [...selectedNew, ...selectedReview].sort(() => 0.5 - Math.random()).map(w => ({
                ...w,
                isNew: !history[w.word.toLowerCase()],
                qType: Math.random() > 0.5 ? 'audio' : 'meaning'
            }));

            if(sessionQueue.length === 0) { alert("No words found!"); return; }

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('study-screen').classList.remove('hidden');
            showQuestion();
        }

        function showQuestion() {
            isReviewMode = false;
            let current = sessionQueue[0];
            document.getElementById('question-phase').classList.remove('hidden');
            document.getElementById('review-area').classList.add('hidden');
            document.getElementById('user-input').value = ""; document.getElementById('user-input').disabled = false;
            document.getElementById('user-input').focus();

            let badge = document.getElementById('word-status-badge');
            badge.innerHTML = current.isNew ? '<span class="badge badge-new">âœ¨ NEW WORD</span>' : '<span class="badge badge-review">ðŸ”„ REVIEW</span>';

            if (current.qType === 'audio') {
                document.getElementById('exercise-type').innerText = "Listening Task";
                document.getElementById('display-meaning-q').innerText = "???";
                playAudio();
            } else {
                document.getElementById('exercise-type').innerText = "Reading Task";
                document.getElementById('display-meaning-q').innerText = current.meaning;
            }
        }

        function playAudio() {
            window.speechSynthesis.cancel();
            let msg = new SpeechSynthesisUtterance(sessionQueue[0].word);
            msg.lang = 'en-US'; msg.rate = 0.85; window.speechSynthesis.speak(msg);
        }

        function checkAnswer() {
            let current = sessionQueue[0];
            let userAns = document.getElementById('user-input').value.trim().toLowerCase();
            let correctAns = current.word.toLowerCase();
            isReviewMode = true;
            document.getElementById('user-input').disabled = true;
            document.getElementById('review-area').classList.remove('hidden');
            
            document.getElementById('rev-word').innerText = current.word;
            document.getElementById('rev-phonetic').innerText = current.phonetic || "";
            document.getElementById('rev-meaning').innerText = current.meaning;
            document.getElementById('rev-example').innerText = current.example || "";
            document.getElementById('rev-synonyms').innerText = current.synonyms || "";

            let feedback = document.getElementById('feedback');
            if (userAns === correctAns) {
                feedback.innerText = "âœ… CORRECT!"; feedback.style.color = "var(--success)";
                current.isCorrect = true;
                markAsLearned(current.word);
            } else {
                feedback.innerText = "âŒ INCORRECT!"; feedback.style.color = "var(--error)";
                current.isCorrect = false;
            }
            document.getElementById('btn-continue').focus();
        }

        function markAsLearned(word) {
            let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || "{}");
            history[word.toLowerCase()] = true;
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
        }

        function continueNext() {
            let last = sessionQueue.shift();
            if (!last.isCorrect) sessionQueue.push(last); // Repeat until correct
            if (sessionQueue.length === 0) { alert("Session Complete!"); location.reload(); }
            else { showQuestion(); }
        }

        function resetHistory() { if(confirm("Clear history?")) { localStorage.removeItem(HISTORY_KEY); location.reload(); } }
        document.getElementById('user-input').addEventListener('keypress', (e) => { if (e.key === 'Enter' && !isReviewMode) checkAnswer(); });
        window.addEventListener('keypress', (e) => { if (e.key === 'Enter' && isReviewMode) continueNext(); });
    </script>
</body>
</html>
